import{e as A,r as c,s as j,j as p,q as S,b3 as $,Q as B,U as R,C as T,B as P,M as X}from"./index-DjcYiVW5.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],z=A("plus",Y);function D({selected:t,setIsSelected:r,card:i,size:n="default",clickable:s=!0}){var I,L;const o=c.useRef(null),[d,g]=c.useState({x:0,y:0}),[e,l]=c.useState(!1),w=c.useRef(O(u=>g(u),50)),m=u=>{w.current({x:u.clientX,y:u.clientY})},f=c.useCallback(()=>{l(!0),window.addEventListener("mousemove",m)},[]),x=c.useCallback(()=>{l(!1),window.removeEventListener("mousemove",m)},[]);let y=0,v=0;if(o.current&&e){const u=o.current.getBoundingClientRect(),_=u.left+u.width/2,N=u.top+u.height/2;y=d.x-_,v=d.y-N}const a=(u,_,N)=>Math.min(Math.max(u,_),N),h=e?a(y/4,-10,10):0,C=e?a(-v/4,-10,10):0,b={transform:`perspective(1000px)
                   rotateY(${h}deg)
                   rotateX(${C}deg)
                   scale(${e?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:s?"pointer":"default",opacity:t?1:.5,width:n==="small"?"80px":"100%",height:n==="small"?"112px":"auto"},M=j.language.split("-")[0].toUpperCase(),E=(L=(I=i.image)==null?void 0:I.split("/").at(-1))==null?void 0:L.replace(/_[A-Z]{2}\.webp$/,`_${M}.webp`),U=`/images/${j.language}/${E}`;return p.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:e?10:0},children:E&&p.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>r==null?void 0:r(!t),ref:o,className:"card-test",style:b,src:`${U}`,alt:S(i,j.language),onMouseEnter:f,onMouseLeave:x,onError:u=>{var _;u.target.src=`/images/en-US/${(_=i.image)==null?void 0:_.split("/").at(-1)}`}})})}const O=(t,r)=>{let i=0,n=null;return(...s)=>{const o=performance.now(),d=o-i;if(d<r){n||(n=setTimeout(()=>{i=performance.now(),n=null,t(...s)},r-d));return}i=o,t(...s)}},k={};function H({card:t,useMaxWidth:r=!1}){const i=B();if(t.linkedCardID)return null;const{user:n,setIsLoginDialogOpen:s}=c.use(R),{ownedCards:o,setOwnedCards:d,setSelectedCardId:g}=c.use(T),[e,l]=c.useState(t.amount_owned||0),[w,m]=c.useState(0);c.useEffect(()=>{m(e)},[e]);const f=c.useCallback(async(a,h)=>{const C=Math.max(0,h);l(C),k[a]&&window.clearTimeout(k[a]),k[a]=window.setTimeout(async()=>{if(!n||!n.user.email)throw new Error("User not logged in");const b=o.find(E=>E.card_id===a);b?b.amount_owned=C:o.push({email:n.user.email,card_id:a,amount_owned:C});const{error:M}=await $.from("collection").upsert({card_id:a,amount_owned:C,email:n.user.email});if(M)throw new Error("Error updating collection")},1e3)},[o,n,d,e]),x=c.useCallback(async a=>{if(!n){s(!0);return}await f(a,e+1)},[f]),y=c.useCallback(async a=>{if(!n){s(!0);return}await f(a,e-1)},[f]),v=async a=>{const h=a.target.value===""?0:Number.parseInt(a.target.value,10);!Number.isNaN(h)&&h>=0&&await f(t.card_id,h)};return p.jsxs("div",{className:`group flex w-fit ${r?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg cursor-pointer`,children:[p.jsx("div",{onClick:()=>g(t.card_id),children:p.jsx(D,{card:t,selected:e>0,clickable:!r})}),p.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[t.card_id," - ",S(t,j.language)]}),p.jsxs("div",{className:"flex items-center gap-x-1",children:[!i.friendId&&p.jsx(P,{variant:"ghost",size:"icon",onClick:()=>y(t.card_id),className:"rounded-full",tabIndex:-1,children:p.jsx(X,{})}),p.jsx("input",{min:"0",max:"99",type:"text",disabled:!!i.friendId,value:w,onChange:v,className:"w-7 text-center border-none rounded",onFocus:a=>a.target.select()}),!i.friendId&&p.jsx(P,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>x(t.card_id),tabIndex:-1,children:p.jsx(z,{})})]})]})}const V=async(t,r,i,n,s)=>{if(!s||!s.user.email)throw new Error("User not logged in");if(r<0)throw new Error("New amount cannot be negative");const o=[...i],d=t.map(e=>({card_id:e,amount_owned:r,email:s.user.email})),{error:g}=await $.from("collection").upsert(d);if(g)throw new Error("Error bulk updating collection");for(const e of t){const l=o.find(w=>w.card_id===e);l?(console.log("Updating existing card:",e),l.amount_owned=r):l||(console.log("Adding new card:",e),o.push({email:s.user.email,card_id:e,amount_owned:r}))}n([...o])},q=async(t,r,i,n,s)=>{if(!s||!s.user.email)throw new Error("User not logged in");const o=[...i],d=[];for(const e of t){const l=o.find(x=>x.card_id===e),w=(l==null?void 0:l.amount_owned)||0,m=Math.max(0,w+r),f=d.find(x=>x.card_id===e);f?f.amount_owned=m:d.push({card_id:e,amount_owned:m,email:s.user.email}),l?(console.log("Incrementing existing card:",e,"from",w,"to",m),l.amount_owned=m):!l&&m>0&&(console.log("Adding new card:",e,"with amount",m),o.push({email:s.user.email,card_id:e,amount_owned:m}))}const{error:g}=await $.from("collection").upsert(d);if(g)throw new Error("Error bulk updating collection");n([...o])};export{H as C,D as F,z as P,q as i,V as u};
