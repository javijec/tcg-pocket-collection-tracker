import{e as U,r as c,B as M,j as m,A as S,ar as $,Y as A,U as Y,C as B,D as P,M as D}from"./index-iSrh-v3v.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],T=U("plus",R);function X({selected:t,setIsSelected:r,card:i,size:o="default"}){var I,L;const n=c.useRef(null),[a,u]=c.useState({x:0,y:0}),[p,e]=c.useState(!1),l=c.useRef(z(d=>u(d),50)),g=d=>{l.current({x:d.clientX,y:d.clientY})},f=c.useCallback(()=>{e(!0),window.addEventListener("mousemove",g)},[]),w=c.useCallback(()=>{e(!1),window.removeEventListener("mousemove",g)},[]);let x=0,y=0;if(n.current&&p){const d=n.current.getBoundingClientRect(),_=d.left+d.width/2,N=d.top+d.height/2;x=a.x-_,y=a.y-N}const v=(d,_,N)=>Math.min(Math.max(d,_),N),s=p?v(x/4,-10,10):0,h=p?v(-y/4,-10,10):0,C={transform:`perspective(1000px)
                   rotateY(${s}deg)
                   rotateX(${h}deg)
                   scale(${p?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:"pointer",opacity:t?1:.5,width:o==="small"?"80px":"100%",height:o==="small"?"112px":"auto"},b=M.language.split("-")[0].toUpperCase(),E=(L=(I=i.image)==null?void 0:I.split("/").at(-1))==null?void 0:L.replace(/_[A-Z]{2}\.webp$/,`_${b}.webp`),j=`/images/${M.language}/${E}`;return m.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:p?10:0},children:E&&m.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>r==null?void 0:r(!t),ref:n,className:"card-test",style:C,src:`${j}`,alt:S(i,M.language),onMouseEnter:f,onMouseLeave:w,onError:d=>{var _;d.target.src=`/images/en-US/${(_=i.image)==null?void 0:_.split("/").at(-1)}`}})})}const z=(t,r)=>{let i=0,o=null;return(...n)=>{const a=performance.now(),u=a-i;if(u<r){o||(o=setTimeout(()=>{i=performance.now(),o=null,t(...n)},r-u));return}i=a,t(...n)}},k={};function F({card:t,useMaxWidth:r=!1}){const i=A();if(t.linkedCardID)return null;const{user:o,setIsLoginDialogOpen:n}=c.use(Y),{ownedCards:a,setOwnedCards:u,setSelectedCardId:p}=c.use(B),[e,l]=c.useState(t.amount_owned||0),[g,f]=c.useState(0);c.useEffect(()=>{f(e)},[e]);const w=c.useCallback(async(s,h)=>{const C=Math.max(0,h);l(C),k[s]&&window.clearTimeout(k[s]),k[s]=window.setTimeout(async()=>{if(!o||!o.user.email)throw new Error("User not logged in");const b=a.find(j=>j.card_id===s);b?b.amount_owned=C:a.push({email:o.user.email,card_id:s,amount_owned:C});const{error:E}=await $.from("collection").upsert({card_id:s,amount_owned:C,email:o.user.email});if(E)throw new Error("Error updating collection")},1e3)},[a,o,u,e]),x=c.useCallback(async s=>{if(!o){n(!0);return}await w(s,e+1)},[w]),y=c.useCallback(async s=>{if(!o){n(!0);return}await w(s,e-1)},[w]),v=async s=>{const h=s.target.value===""?0:Number.parseInt(s.target.value,10);!Number.isNaN(h)&&h>=0&&await w(t.card_id,h)};return m.jsxs("div",{className:`group flex w-fit ${r?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg cursor-pointer`,children:[m.jsx("div",{onClick:()=>p(t.card_id),children:m.jsx(X,{card:t,selected:e>0})}),m.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[t.card_id," - ",S(t,M.language)]}),m.jsxs("div",{className:"flex items-center gap-x-1",children:[!i.friendId&&m.jsx(P,{variant:"ghost",size:"icon",onClick:()=>y(t.card_id),className:"rounded-full",tabIndex:-1,children:m.jsx(D,{})}),m.jsx("input",{min:"0",max:"99",type:"text",disabled:!!i.friendId,value:g,onChange:v,className:"w-7 text-center border-none rounded",onFocus:s=>s.target.select()}),!i.friendId&&m.jsx(P,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>x(t.card_id),tabIndex:-1,children:m.jsx(T,{})})]})]})}const H=async(t,r,i,o,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");if(r<0)throw new Error("New amount cannot be negative");const a=[...i],u=t.map(e=>({card_id:e,amount_owned:r,email:n.user.email})),{error:p}=await $.from("collection").upsert(u);if(p)throw new Error("Error bulk updating collection");for(const e of t){const l=a.find(g=>g.card_id===e);l?(console.log("Updating existing card:",e),l.amount_owned=r):l||(console.log("Adding new card:",e),a.push({email:n.user.email,card_id:e,amount_owned:r}))}o([...a])},V=async(t,r,i,o,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");const a=[...i],u=[];for(const e of t){const l=a.find(x=>x.card_id===e),g=(l==null?void 0:l.amount_owned)||0,f=Math.max(0,g+r),w=u.find(x=>x.card_id===e);w?w.amount_owned=f:u.push({card_id:e,amount_owned:f,email:n.user.email}),l?(console.log("Incrementing existing card:",e,"from",g,"to",f),l.amount_owned=f):!l&&f>0&&(console.log("Adding new card:",e,"with amount",f),a.push({email:n.user.email,card_id:e,amount_owned:f}))}const{error:p}=await $.from("collection").upsert(u);if(p)throw new Error("Error bulk updating collection");o([...a])};export{F as C,X as F,T as P,V as i,H as u};
